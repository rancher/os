#!/bin/bash
set -e

cd $(dirname $0)/..

IMAGES=$(bin/host_ros c images -i build/initrd/usr/share/ros/os-config.yml)
for i in $IMAGES; do
    if [ "${FORCE_PULL}" = "1" ] || ! docker inspect $i >/dev/null 2>&1; then
        docker pull $i
    fi
done

# TODO - this causes the start times of the integration-tests to go up massivly
# add the images that we normally pull from hub
#if [ -e "assets/os-images.list" ]; then
#  for image in $(cat assets/os-images.list | tr "\n" " "); do
#    if [[ "$image" == *"xfce"* \
#          || "$image" == *"selinux"* \
#          || "$image" == *"fedora"* \
#          || "$image" == *"centos"* \
#          || "$image" == *"debian"* \
#          || "$image" == *"ubuntu"* \
#          || "$image" == *"openvmtools"* \
#       ]]; then
#      continue
#    fi
#    DEVIMAGES="${DEVIMAGES} ${image}"
#  done
#fi

echo "adding these images into the initrd (${IMAGES} ${DEVIMAGES})"
for image in ${IMAGES} ${DEVIMAGES}; do
  docker images --format "{{.Size}}\t\t{{.Repository}}:{{.Tag}}" ${image}
done

docker save ${IMAGES} ${DEVIMAGES} > build/images.tar
